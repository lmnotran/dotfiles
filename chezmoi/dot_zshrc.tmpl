# vim: set ft=zsh:
# Managed by chezmoi
# Machine: {{ .chezmoi.hostname }} | User: {{ .chezmoi.username }} | OS: {{ .chezmoi.os }}

setopt EXTENDED_GLOB

#===============================================================================
# pyenv
#===============================================================================
export PYENV_ROOT="$HOME/.pyenv"
[[ -d "$PYENV_ROOT/bin" ]] && export PATH="$PYENV_ROOT/bin:$PATH"
if command -v pyenv >/dev/null; then
  eval "$(pyenv init -)"
fi

#===============================================================================
# Machine-specific config (before plugins)
#===============================================================================
{{- if eq .chezmoi.hostname "bigboi" }}
# bigboi-specific
umask 002
{{- end }}

{{- if eq .chezmoi.os "linux" }}
# Linuxbrew - check common install locations
if [[ -d /home/linuxbrew/.linuxbrew ]]; then
  eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
elif [[ -d ~/.linuxbrew ]]; then
  eval "$(~/.linuxbrew/bin/brew shellenv)"
fi
{{- end }}

{{- if eq .chezmoi.os "darwin" }}
# macOS Homebrew
if [[ -d /opt/homebrew ]]; then
  eval "$(/opt/homebrew/bin/brew shellenv)"
elif [[ -d /usr/local/Homebrew ]]; then
  eval "$(/usr/local/bin/brew shellenv)"
fi
test -e "${HOME}/.iterm2_shell_integration.zsh" && source "${HOME}/.iterm2_shell_integration.zsh" || true
export PATH="/opt/homebrew/opt/grep/libexec/gnubin:$PATH"
{{- end }}

{{- if eq .chezmoi.hostname "lemon.whatbox.ca" }}
# Custom brew prefix
export BREW_PREFIX="${HOME}/repos/brew/"
export PATH="${BREW_PREFIX}/bin:$PATH"
eval "$("${BREW_PREFIX}"/bin/brew shellenv)"
{{- end }}

export PATH="$HOME/.local/bin:$PATH"
export TERM="xterm-256color"

#===============================================================================
# oh-my-zsh configuration
#===============================================================================
COMPLETION_WAITING_DOTS="true"
HIST_STAMPS="yyyy-mm-dd"

#===============================================================================
# antidote plugin manager
#===============================================================================
ANTIDOTE_HOME="${XDG_DATA_HOME:-$HOME/.local/share}/antidote"
if [[ -r "$ANTIDOTE_HOME/antidote.zsh" ]]; then
  source "$ANTIDOTE_HOME/antidote.zsh"
  antidote load
elif [[ -r "$HOME/.antidote/antidote.zsh" ]]; then
  source "$HOME/.antidote/antidote.zsh"
  antidote load
fi

#===============================================================================
# fzf integration (native, replaces omz plugin)
#===============================================================================
if command -v fzf >/dev/null 2>&1; then
  # fzf 0.48+ supports --zsh, older versions need manual sourcing
  eval "$(fzf --zsh 2>/dev/null)" || {
    for dir in /usr/share/fzf "${HOMEBREW_PREFIX:-/opt/homebrew}/opt/fzf/shell"; do
      [[ -f "$dir/key-bindings.zsh" ]] && source "$dir/key-bindings.zsh"
      [[ -f "$dir/completion.zsh" ]] && source "$dir/completion.zsh"
    done
  }
fi

#===============================================================================
# User configuration
#===============================================================================
# Preferred editor
if [[ "$TERM_PROGRAM" == "vscode" || -n "$VSCODE_PID" || -n "$VSCODE_GIT_IPC_HANDLE" ]] && command -v code >/dev/null 2>&1; then
  export EDITOR="code --wait --reuse-window"
elif command -v nvim >/dev/null 2>&1; then
  export EDITOR="nvim"
else
  export EDITOR="vi"
fi
export VISUAL="$EDITOR"
export GIT_EDITOR="$EDITOR"

# Source additional zsh configs
source_if_exists() { [[ -r "$1" ]] && source "$1" || true; }
source_if_exists "$HOME/.config/zsh/aliases.zsh"

export GPG_TTY=$(tty)
export ZSH_TMUX_UNICODE=true
export GO111MODULE=on

{{- $userHost := printf "%s@%s" .chezmoi.username .chezmoi.hostname -}}
{{- $isWork := or (hasPrefix "usmastra" .chezmoi.username) (has $userHost .work.knownUserHosts) -}}
{{- if $isWork }}
#===============================================================================
# Work (lego) config
#===============================================================================
source_if_exists "$HOME/.config/zsh/lego.zsh"
{{- end }}

# Optional: local overrides outside of git
source_if_exists "$HOME/.zshrc.local"
