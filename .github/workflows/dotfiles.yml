name: Dotfiles CI

on:
  push:
    branches: [main, master, "feature/**"]
    paths:
      - "chezmoi/**"
      - "script/**"
      - ".github/workflows/dotfiles.yml"
  pull_request:
    branches: [main, master]
    paths:
      - "chezmoi/**"
      - "script/**"
      - ".github/workflows/dotfiles.yml"
  workflow_dispatch:

env:
  # Skip interactive prompts
  DEBIAN_FRONTEND: noninteractive

jobs:
  # ─────────────────────────────────────────────────────────────────────────
  # Lint shell scripts
  # ─────────────────────────────────────────────────────────────────────────
  shellcheck:
    name: Lint Shell Scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Run ShellCheck on scripts
        run: |
          echo "Checking script/ directory..."
          # Only check bash/sh scripts (skip python, zsh-only scripts)
          for f in script/*; do
            # Skip non-files
            [[ -f "$f" ]] || continue

            # Check shebang to determine if shellcheck supports it
            shebang=$(head -1 "$f")
            case "$shebang" in
              *python*|*zsh*)
                echo "Skipping $f (not a bash/sh script)"
                continue
                ;;
            esac

            echo "Checking $f..."
            shellcheck "$f"
          done

          echo ""
          echo "Checking chezmoi run scripts..."
          # Extract bash from .tmpl files for checking
          for f in chezmoi/run_*.sh.tmpl; do
            if [[ -f "$f" ]]; then
              echo "Checking $f..."
              # Remove chezmoi template directives for shellcheck
              sed 's/{{.*}}/PLACEHOLDER/g' "$f" | shellcheck -s bash -
            fi
          done

  # ─────────────────────────────────────────────────────────────────────────
  # Test chezmoi apply on Linux
  # ─────────────────────────────────────────────────────────────────────────
  chezmoi-linux:
    name: Chezmoi Apply (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install chezmoi
        run: |
          sh -c "$(curl -fsLS get.chezmoi.io)" -- -b ~/.local/bin
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Verify chezmoi version
        run: chezmoi --version

      - name: Test chezmoi init (dry-run)
        run: |
          chezmoi init --source ./chezmoi --dry-run --verbose

      - name: Test chezmoi apply (skip run_once scripts)
        run: |
          # Apply dotfiles but skip the install-deps script
          # (we don't want to install all deps in CI, just test the apply)
          chezmoi apply --source ./chezmoi --exclude=scripts --verbose

      - name: Verify dotfiles were applied
        run: |
          echo "Checking symlinked/copied files..."

          # Check critical files exist
          test -f ~/.zshrc && echo "✓ ~/.zshrc exists"
          test -f ~/.tmux.conf && echo "✓ ~/.tmux.conf exists"
          test -f ~/.gitconfig && echo "✓ ~/.gitconfig exists"
          test -f ~/.zsh_plugins.txt && echo "✓ ~/.zsh_plugins.txt exists"
          test -d ~/.config/nvim && echo "✓ ~/.config/nvim exists"
          test -f ~/.config/nvim/init.lua && echo "✓ ~/.config/nvim/init.lua exists"

          echo ""
          echo "All critical dotfiles present!"

  # ─────────────────────────────────────────────────────────────────────────
  # Test chezmoi apply on macOS
  # ─────────────────────────────────────────────────────────────────────────
  chezmoi-macos:
    name: Chezmoi Apply (macOS)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install chezmoi
        run: |
          sh -c "$(curl -fsLS get.chezmoi.io)" -- -b ~/.local/bin
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Test chezmoi apply (skip run_once scripts)
        run: |
          chezmoi apply --source ./chezmoi --exclude=scripts --verbose

      - name: Verify dotfiles were applied
        run: |
          test -f ~/.zshrc && echo "✓ ~/.zshrc exists"
          test -f ~/.tmux.conf && echo "✓ ~/.tmux.conf exists"
          test -f ~/.gitconfig && echo "✓ ~/.gitconfig exists"
          test -d ~/.config/nvim && echo "✓ ~/.config/nvim exists"

  # ─────────────────────────────────────────────────────────────────────────
  # Test zsh configuration
  # ─────────────────────────────────────────────────────────────────────────
  zsh-config:
    name: Test Zsh Config
    runs-on: ubuntu-latest
    needs: chezmoi-linux
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh fzf

      - name: Install chezmoi and apply dotfiles
        run: |
          sh -c "$(curl -fsLS get.chezmoi.io)" -- -b ~/.local/bin
          export PATH="$HOME/.local/bin:$PATH"
          chezmoi apply --source ./chezmoi --exclude=scripts

      - name: Install antidote (zsh plugin manager)
        run: |
          git clone --depth=1 https://github.com/mattmc3/antidote.git \
            "${XDG_DATA_HOME:-$HOME/.local/share}/antidote"

      - name: Test zsh syntax
        shell: zsh {0}
        run: |
          # Check zshrc syntax by parsing without executing
          zsh -n ~/.zshrc && echo "✓ ~/.zshrc syntax OK"

      - name: Test zsh interactive startup
        shell: zsh {0}
        run: |
          # Create ~/.ssh with a dummy key so ssh-agent plugin works
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keygen -t ed25519 -f ~/.ssh/id_ed25519 -N "" -q

          # Source zshrc and check for errors
          set +e
          output=$(source ~/.zshrc 2>&1)
          exit_code=$?
          set -e

          echo "$output"

          # Fail on actual errors (not plugin warnings about missing optional tools)
          # - Exit code non-zero indicates a real problem
          # - "command not found" for core commands is an error
          # Plugin warnings like "[oh-my-zsh] fzf plugin: Cannot find" are OK
          if [[ $exit_code -ne 0 ]]; then
            echo "❌ zshrc exited with code $exit_code!"
            exit 1
          fi

          # Check for fatal errors (skip known plugin warnings)
          if echo "$output" | grep -v "\[oh-my-zsh\]" | grep -qiE "^.*: command not found|error:"; then
            echo "❌ zshrc has errors!"
            exit 1
          fi

          echo ""
          echo "SHELL=$SHELL"
          echo "ZSH_VERSION=$ZSH_VERSION"
          echo "✓ zshrc loaded successfully"

  # ─────────────────────────────────────────────────────────────────────────
  # Test neovim configuration
  # ─────────────────────────────────────────────────────────────────────────
  nvim-config:
    name: Test Neovim Config
    runs-on: ubuntu-latest
    needs: chezmoi-linux
    steps:
      - uses: actions/checkout@v4

      - name: Install Neovim (latest stable)
        run: |
          # Ubuntu apt has old neovim - install latest stable from GitHub releases
          curl -LO https://github.com/neovim/neovim/releases/download/stable/nvim-linux-x86_64.tar.gz
          sudo tar -xzf nvim-linux-x86_64.tar.gz -C /opt
          sudo ln -sf /opt/nvim-linux-x86_64/bin/nvim /usr/local/bin/nvim
          nvim --version | head -1

      - name: Install chezmoi and apply dotfiles
        run: |
          sh -c "$(curl -fsLS get.chezmoi.io)" -- -b ~/.local/bin
          export PATH="$HOME/.local/bin:$PATH"
          chezmoi apply --source ./chezmoi --exclude=scripts

      - name: Verify neovim config structure
        run: |
          test -f ~/.config/nvim/init.lua && echo "✓ init.lua exists"
          test -d ~/.config/nvim/lua && echo "✓ lua/ directory exists"

          echo ""
          echo "Neovim config files:"
          find ~/.config/nvim -type f -name "*.lua" | head -20

      - name: Test neovim loads without errors
        run: |
          # Run neovim in headless mode and capture output
          output=$(nvim --headless -c 'echo "Neovim loaded successfully"' -c 'qa' 2>&1 | tail -80)
          echo "$output"

          # Fail if there are Lua/config errors
          if echo "$output" | grep -qiE "^E[0-9]+:|Error while calling lua|Failed to run|module .* not found"; then
            echo ""
            echo "❌ Neovim config has errors!"
            exit 1
          fi
          echo "✓ Neovim config OK"

      - name: Check neovim health (basic)
        run: |
          # Run checkhealth in headless mode
          # This is informational only - don't fail on health warnings
          timeout 30 nvim --headless -c 'checkhealth vim.health' -c 'qa' 2>&1 | tail -30
          echo "✓ Health check complete (informational)"

  # ─────────────────────────────────────────────────────────────────────────
  # Test tmux configuration
  # ─────────────────────────────────────────────────────────────────────────
  tmux-config:
    name: Test Tmux Config
    runs-on: ubuntu-latest
    needs: chezmoi-linux
    steps:
      - uses: actions/checkout@v4

      - name: Install tmux
        run: |
          sudo apt-get update
          sudo apt-get install -y tmux

      - name: Install chezmoi and apply dotfiles
        run: |
          sh -c "$(curl -fsLS get.chezmoi.io)" -- -b ~/.local/bin
          export PATH="$HOME/.local/bin:$PATH"
          chezmoi apply --source ./chezmoi --exclude=scripts

      - name: Install gpakosz/.tmux framework
        run: |
          git clone --depth=1 https://github.com/gpakosz/.tmux.git ~/.tmux

      - name: Verify tmux config files
        run: |
          test -f ~/.tmux.conf && echo "✓ ~/.tmux.conf exists"
          test -f ~/.tmux.conf.local && echo "✓ ~/.tmux.conf.local exists"
          test -f ~/.tmux/.tmux.conf && echo "✓ gpakosz/.tmux installed"

      - name: Test tmux config syntax
        run: |
          # Start a tmux server and check for config errors
          tmux start-server
          tmux new-session -d -s test 2>&1 && {
            echo "✓ tmux session started successfully"
            tmux kill-session -t test
          } || {
            echo "⚠ tmux config may have issues"
            exit 1
          }

  # ─────────────────────────────────────────────────────────────────────────
  # Test install-deps script (dry-run)
  # ─────────────────────────────────────────────────────────────────────────
  install-deps:
    name: Test Install Script
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Test install-deps --dry-run
        run: |
          chmod +x script/install-deps
          ./script/install-deps --dry-run

      - name: Test setup --dry-run
        run: |
          chmod +x script/setup
          # Install chezmoi first (setup expects it or will install it)
          sh -c "$(curl -fsLS get.chezmoi.io)" -- -b ~/.local/bin
          export PATH="$HOME/.local/bin:$PATH"
          ./script/setup --dry-run
