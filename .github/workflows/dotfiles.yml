name: Dotfiles CI

on:
  push:
    branches: [main, master, "feature/**"]
    paths:
      - "chezmoi/**"
      - "script/**"
      - ".github/workflows/dotfiles.yml"
  pull_request:
    branches: [main, master]
    paths:
      - "chezmoi/**"
      - "script/**"
      - ".github/workflows/dotfiles.yml"
  workflow_dispatch:

# Cancel in-progress runs on new pushes to the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Skip interactive prompts
  DEBIAN_FRONTEND: noninteractive

jobs:
  # ─────────────────────────────────────────────────────────────────────────
  # Lint shell scripts
  # ─────────────────────────────────────────────────────────────────────────
  shellcheck:
    name: Lint Shell Scripts
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Run ShellCheck on scripts
        uses: ludeeus/action-shellcheck@2.0.0
        with:
          scandir: './script'
          ignore_paths: '*.py'
          severity: warning

      - name: Check chezmoi template scripts
        run: |
          echo "Checking chezmoi run scripts..."
          # Extract bash from .tmpl files for checking
          for f in chezmoi/run_*.sh.tmpl; do
            if [[ -f "$f" ]]; then
              echo "Checking $f..."
              # Remove chezmoi template directives for shellcheck
              sed 's/{{.*}}/PLACEHOLDER/g' "$f" | shellcheck -s bash - || exit 1
            fi
          done
          echo "✓ All chezmoi templates passed"

  # ─────────────────────────────────────────────────────────────────────────
  # Test chezmoi apply on multiple platforms
  # ─────────────────────────────────────────────────────────────────────────
  chezmoi-apply:
    name: Chezmoi Apply (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    outputs:
      chezmoi-version: ${{ steps.chezmoi.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Install chezmoi
        id: chezmoi
        run: |
          sh -c "$(curl -fsLS get.chezmoi.io)" -- -b ~/.local/bin
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          echo "version=$(~/.local/bin/chezmoi --version | head -1)" >> $GITHUB_OUTPUT

      - name: Test chezmoi init (dry-run)
        run: chezmoi init --source ./chezmoi --dry-run --verbose

      - name: Test chezmoi apply (skip run_once scripts)
        run: |
          # Apply dotfiles but skip the install-deps script
          # (we don't want to install all deps in CI, just test the apply)
          chezmoi apply --source ./chezmoi --exclude=scripts --verbose

      - name: Verify dotfiles were applied
        run: |
          files=(
            ~/.zshrc
            ~/.tmux.conf
            ~/.gitconfig
            ~/.zsh_plugins.txt
            ~/.config/nvim/init.lua
          )
          dirs=(
            ~/.config/nvim
          )

          failed=0
          for f in "${files[@]}"; do
            [[ -f "$f" ]] && echo "✓ $f" || { echo "✗ $f"; failed=1; }
          done
          for d in "${dirs[@]}"; do
            [[ -d "$d" ]] && echo "✓ $d" || { echo "✗ $d"; failed=1; }
          done

          [[ $failed -eq 0 ]] || { echo "❌ Missing dotfiles!"; exit 1; }
          echo "✓ All dotfiles present!"

  # ─────────────────────────────────────────────────────────────────────────
  # Test zsh configuration
  # ─────────────────────────────────────────────────────────────────────────
  zsh-config:
    name: Test Zsh Config
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: chezmoi-apply
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh fzf

      - name: Install chezmoi and apply dotfiles
        run: |
          sh -c "$(curl -fsLS get.chezmoi.io)" -- -b ~/.local/bin
          export PATH="$HOME/.local/bin:$PATH"
          chezmoi apply --source ./chezmoi --exclude=scripts

      - name: Cache antidote
        uses: actions/cache@v4
        with:
          path: ~/.local/share/antidote
          key: antidote-${{ hashFiles('chezmoi/dot_zsh_plugins.txt') }}

      - name: Install antidote (zsh plugin manager)
        run: |
          if [[ ! -d "${XDG_DATA_HOME:-$HOME/.local/share}/antidote" ]]; then
            git clone --depth=1 https://github.com/mattmc3/antidote.git \
              "${XDG_DATA_HOME:-$HOME/.local/share}/antidote"
          fi

      - name: Test zsh syntax
        shell: zsh {0}
        run: |
          # Check zshrc syntax by parsing without executing
          zsh -n ~/.zshrc && echo "✓ ~/.zshrc syntax OK"

      - name: Test zsh interactive startup
        shell: zsh {0}
        run: |
          # Create ~/.ssh with a dummy key so ssh-agent plugin works
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keygen -t ed25519 -f ~/.ssh/id_ed25519 -N "" -q

          # Source zshrc and check for errors
          set +e
          output=$(source ~/.zshrc 2>&1)
          exit_code=$?
          set -e

          echo "$output"

          # Fail on actual errors (not plugin warnings about missing optional tools)
          # - Exit code non-zero indicates a real problem
          # - "command not found" for core commands is an error
          # Plugin warnings like "[oh-my-zsh] fzf plugin: Cannot find" are OK
          if [[ $exit_code -ne 0 ]]; then
            echo "❌ zshrc exited with code $exit_code!"
            exit 1
          fi

          # Check for fatal errors (skip known plugin warnings)
          if echo "$output" | grep -v "\[oh-my-zsh\]" | grep -qiE "^.*: command not found|error:"; then
            echo "❌ zshrc has errors!"
            exit 1
          fi

          echo ""
          echo "ZSH_VERSION=$ZSH_VERSION"
          echo "✓ zshrc loaded successfully"

  # ─────────────────────────────────────────────────────────────────────────
  # Test neovim configuration
  # ─────────────────────────────────────────────────────────────────────────
  nvim-config:
    name: Test Neovim Config
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: chezmoi-apply
    steps:
      - uses: actions/checkout@v4

      - name: Install Neovim
        uses: rhysd/action-setup-vim@v1
        with:
          neovim: true
          version: stable

      - name: Install chezmoi and apply dotfiles
        run: |
          sh -c "$(curl -fsLS get.chezmoi.io)" -- -b ~/.local/bin
          export PATH="$HOME/.local/bin:$PATH"
          chezmoi apply --source ./chezmoi --exclude=scripts

      - name: Cache lazy.nvim plugins
        uses: actions/cache@v4
        with:
          path: ~/.local/share/nvim/lazy
          key: lazy-nvim-${{ hashFiles('chezmoi/private_dot_config/nvim/lazy-lock.json') }}

      - name: Verify neovim config structure
        run: |
          test -f ~/.config/nvim/init.lua && echo "✓ init.lua exists"
          test -d ~/.config/nvim/lua && echo "✓ lua/ directory exists"

          echo ""
          echo "Neovim config files:"
          find ~/.config/nvim -type f -name "*.lua" | head -20

      - name: Test neovim loads without errors
        run: |
          # Run neovim in headless mode and capture output
          output=$(nvim --headless -c 'echo "Neovim loaded successfully"' -c 'qa' 2>&1 | tail -80)
          echo "$output"

          # Fail if there are Lua/config errors
          if echo "$output" | grep -qiE "^E[0-9]+:|Error while calling lua|Failed to run|module .* not found"; then
            echo ""
            echo "❌ Neovim config has errors!"
            exit 1
          fi
          echo "✓ Neovim config OK"

      - name: Check neovim health (basic)
        run: |
          # Run checkhealth in headless mode
          # This is informational only - don't fail on health warnings
          timeout 30 nvim --headless -c 'checkhealth vim.health' -c 'qa' 2>&1 | tail -30
          echo "✓ Health check complete (informational)"

  # ─────────────────────────────────────────────────────────────────────────
  # Test tmux configuration
  # ─────────────────────────────────────────────────────────────────────────
  tmux-config:
    name: Test Tmux Config
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: chezmoi-apply
    steps:
      - uses: actions/checkout@v4

      - name: Install tmux
        run: |
          sudo apt-get update
          sudo apt-get install -y tmux

      - name: Install chezmoi and apply dotfiles
        run: |
          sh -c "$(curl -fsLS get.chezmoi.io)" -- -b ~/.local/bin
          export PATH="$HOME/.local/bin:$PATH"
          chezmoi apply --source ./chezmoi --exclude=scripts

      - name: Cache gpakosz/.tmux
        uses: actions/cache@v4
        with:
          path: ~/.tmux
          key: gpakosz-tmux-v1

      - name: Install gpakosz/.tmux framework
        run: |
          [[ -d ~/.tmux ]] || git clone --depth=1 https://github.com/gpakosz/.tmux.git ~/.tmux

      - name: Verify tmux config files
        run: |
          test -f ~/.tmux.conf && echo "✓ ~/.tmux.conf exists"
          test -f ~/.tmux.conf.local && echo "✓ ~/.tmux.conf.local exists"
          test -f ~/.tmux/.tmux.conf && echo "✓ gpakosz/.tmux installed"

      - name: Test tmux config syntax
        run: |
          # Start a tmux server and check for config errors
          tmux start-server
          tmux new-session -d -s test 2>&1 && {
            echo "✓ tmux session started successfully"
            tmux kill-session -t test
          } || {
            echo "⚠ tmux config may have issues"
            exit 1
          }

  # ─────────────────────────────────────────────────────────────────────────
  # Test install-deps script (dry-run)
  # ─────────────────────────────────────────────────────────────────────────
  install-deps:
    name: Test Install Script
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Test install-deps --dry-run
        run: |
          chmod +x script/install-deps
          ./script/install-deps --dry-run

      - name: Test setup --dry-run
        run: |
          chmod +x script/setup
          # Install chezmoi first (setup expects it or will install it)
          sh -c "$(curl -fsLS get.chezmoi.io)" -- -b ~/.local/bin
          export PATH="$HOME/.local/bin:$PATH"
          ./script/setup --dry-run

  # ─────────────────────────────────────────────────────────────────────────
  # Summary job for branch protection
  # ─────────────────────────────────────────────────────────────────────────
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [shellcheck, chezmoi-apply, zsh-config, nvim-config, tmux-config, install-deps]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          results=(
            "shellcheck=${{ needs.shellcheck.result }}"
            "chezmoi-apply=${{ needs.chezmoi-apply.result }}"
            "zsh-config=${{ needs.zsh-config.result }}"
            "nvim-config=${{ needs.nvim-config.result }}"
            "tmux-config=${{ needs.tmux-config.result }}"
            "install-deps=${{ needs.install-deps.result }}"
          )

          failed=0
          for r in "${results[@]}"; do
            job="${r%%=*}" result="${r#*=}"
            [[ "$result" == "success" ]] && echo "✓ $job" || { echo "✗ $job ($result)"; failed=1; }
          done

          [[ $failed -eq 0 ]] || { echo "❌ CI failed"; exit 1; }
          echo "✓ All jobs passed!"
