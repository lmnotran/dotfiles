#!/bin/bash
#
# bootstrap - Bootstrap dotfiles via chezmoi
#
# Usage: ./script/bootstrap
#
# This script is the entry point for VS Code devcontainer dotfiles installation.
# It installs chezmoi if needed, then runs chezmoi init --apply.
#
# For a fresh machine without this repo cloned, use:
#   sh -c "$(curl -fsLS get.chezmoi.io)" -- init --apply lmnotran/dotfiles
#
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_DIR="$(dirname "$SCRIPT_DIR")"

# ─────────────────────────────────────────────────────────────────────────────
# Colors
# ─────────────────────────────────────────────────────────────────────────────

if [[ -t 1 ]]; then
    GREEN='\033[0;32m'
    YELLOW='\033[0;33m'
    BLUE='\033[0;34m'
    MAGENTA='\033[0;35m'
    CYAN='\033[0;36m'
    BOLD='\033[1m'
    RESET='\033[0m'
else
    GREEN='' YELLOW='' BLUE='' MAGENTA='' CYAN='' BOLD='' RESET=''
fi

# ─────────────────────────────────────────────────────────────────────────────
# Helper functions
# ─────────────────────────────────────────────────────────────────────────────

log()      { echo -e "${CYAN}[bootstrap]${RESET} $*"; }
log_step() { echo -e "${BOLD}${BLUE}==>${RESET} ${BOLD}$*${RESET}"; }
log_ok()   { echo -e "${GREEN}✓${RESET} $*"; }
log_warn() { echo -e "${YELLOW}⚠${RESET} $*"; }

# ─────────────────────────────────────────────────────────────────────────────
# Main
# ─────────────────────────────────────────────────────────────────────────────

main() {
    cd "$REPO_DIR"

    echo ""
    echo -e "${BOLD}${MAGENTA}  ┌─────────────────────────────────────┐${RESET}"
    echo -e "${BOLD}${MAGENTA}  │       ${CYAN}Dotfiles Bootstrap${MAGENTA}            │${RESET}"
    echo -e "${BOLD}${MAGENTA}  └─────────────────────────────────────┘${RESET}"
    echo ""

    log "Source: $REPO_DIR"
    echo ""

    log_step "Step 1/2: Installing chezmoi"
    if command -v chezmoi &>/dev/null; then
        log_ok "chezmoi already installed"
    else
        # Remove broken symlink if it exists (leftover from stow)
        [[ -L ~/.local/bin ]] && rm ~/.local/bin
        mkdir -p ~/.local/bin
        sh -c "$(curl -fsLS get.chezmoi.io)" -- -b ~/.local/bin
        export PATH="$HOME/.local/bin:$PATH"
        log_ok "chezmoi installed to ~/.local/bin"
    fi
    echo ""

    log_step "Step 2/2: Applying dotfiles"
    chezmoi init --source "$REPO_DIR" --apply
    log_ok "Dotfiles applied"
    echo ""

    echo -e "${BOLD}${GREEN}✓ Bootstrap complete!${RESET}"
    echo ""
    echo -e "${BOLD}Next steps:${RESET}"
    echo -e "  ${CYAN}1.${RESET} Restart your terminal (or run: ${YELLOW}exec zsh${RESET})"
    echo -e "  ${CYAN}2.${RESET} Antidote will auto-install zsh plugins on first launch"
    echo ""
}

main "$@"
