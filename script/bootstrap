#!/bin/bash

set -euxo pipefail

if [[ -n ${BASH_SOURCE[0]} ]]; then
    script_path="${BASH_SOURCE[0]}"
else
    script_path="$0"
fi

script_dir="$(dirname "$(realpath "$script_path")")"
repo_dir="$(dirname "$script_dir")"

install_packages_apt()
{
    echo 'Installing script dependencies...'

    # apt-get update and install dependencies
    sudo apt-get update && sudo apt-get --no-install-recommends install -y coreutils \
        git-lfs \
        unzip \
        dialog \
        wget \
        curl \
        fzf \
        build-essential
}

install_packages_opkg()
{
   echo 'opkg not supported currently' && false
}

install_packages_rpm()
{
    echo 'rpm not supported currently' && false
}

install_brew()
{
    echo 'Installing brew...'
    command -v brew || /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
}

install_packages_brew()
{
    echo 'Installing brew packages...'
    brew install \
        coreutils \
        openjdk@11 \
        grep \
        fzf \
        wget \
        pyenv
}

install_packages_source()
{
    echo 'source not supported currently' && false
}

install_packages_pip3()
{
    pip3 install -U pip
}

install_packages()
{
    PM=none
    if command -v apt-get; then
        PM=apt
    elif command -v rpm; then
        PM=rpm
    elif command -v opkg; then
        PM=opkg
    elif command -v brew; then
        PM=brew
    elif command -v source; then
        PM=source
    else
        echo 'No supported package managers detected.' && false
        exit 1
    fi

    install_packages_$PM

    if command -v pip3; then
        install_packages_pip3
    fi
}

bootstrap_mac()
{
    echo "Bootstrapping mac"
    return
}

install_links()
{
    # Link files from the repo to the home directory

    # Back up existing .zshrc instead of exiting
    if [ -f "${HOME}/.zshrc" ]; then
        echo "Backing up existing .zshrc to .zshrc.bak"
        mv "${HOME}/.zshrc" "${HOME}/.zshrc.bak"
    fi

    # Link .zshrc into $HOME
    ln -s ${repo_dir}/.zshrc ~

    ln -s ${repo_dir}/.zsh_plugins.txt ~
    ln -s ${repo_dir}/.spaceshiprc.zsh ~
}


main()
{
    # Execute any specific bootstrap steps in args
    if [ $# -gt 0 ]; then
        for arg in "$@"; do
            case $arg in
                link)
                    install_links
                    ;;
                mac)
                    bootstrap_mac
                    ;;
                packages)
                    install_packages
                    ;;
                *)
                    echo "Unknown bootstrap step: $arg"
                    ;;
            esac
        done
    else
        # Default bootstrap
        if [[ "$OSTYPE" == "darwin"* ]]; then
            install_brew
        fi

        install_packages

        if [ ! -d "${HOME}/.pyenv" ]; then
            echo "Installing pyenv"
            curl https://pyenv.run | bash
        fi

        set_repo_dir

        if [ ! -d "${HOME}/.oh-my-zsh" ]; then bootstrap_zsh; fi

        # macOS specific bootstrap
        if [[ "$OSTYPE" == "darwin"* ]]; then
            bootstrap_mac
        fi
    fi

    echo "Bootstrap completed successfully."
}

main "$@"

