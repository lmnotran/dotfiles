#!/bin/zsh
# Load secrets from Bitwarden Secrets Manager
# Usage: eval "$(load-secrets <profile>)"
#    or: secrets <profile>  (if alias is set)

set -e

# Secret IDs
CF_APIKEY_ID="2554b589-8b58-4f8a-b273-b3e2013f3ffb"
CF_APITOKEN_ID="62aaa20c-7906-49e4-b8fb-b3e2013f4a4e"
CF_APITOKEN_ZONE_ID="766b63b6-f033-4e11-8e97-b3e2013f5987"
PAPERLESS_SECRET_KEY_ID="f46fac4e-3f11-495a-9664-b3e201400020"
POSTGRES_PASSWORD_ID="dbde1b0d-b2ad-417a-b35a-b3e2014097ba"
PIHOLE_PASSWORD_ID="9d1ebda4-c953-4ce8-900e-b3e2013f990e"
MYSQL_ROOT_PASSWORD_ID="84da66a4-59e6-4c66-a2d1-b3e20143453b"
AVIATIONSTACK_API_KEY_ID="9e347856-9676-44ee-8b80-b3e20140cd7a"
GHCR_TOKEN_ID="ed822e30-40aa-49cc-a7cb-b3e2013eb173"
GITHUB_TOKEN_ID="81abf0ab-cf50-4447-927c-b3e2013ec5e1"

# Output to stderr so it doesn't get captured by eval
log() { echo "$@" >&2; }

# Fetch a secret and print export command
emit_secret() {
    local var_name="$1"
    local secret_id="$2"
    log "Loading ${var_name}..."
    local value
    value="$(bws secret get "$secret_id" 2>/dev/null | jq -r '.value // empty')"
    if [[ -n "$value" ]]; then
        # Escape single quotes in value for safe shell quoting
        value="${value//\'/\'\\\'\'}"
        echo "export ${var_name}='${value}'"
        log "✓ ${var_name}"
    else
        log "✗ ${var_name} failed"
        return 1
    fi
}

# Emit export commands for a profile
emit_profile() {
    local profile="$1"
    case "$profile" in
        cloudflare)
            emit_secret CF_APIKEY "$CF_APIKEY_ID"
            emit_secret CF_APITOKEN "$CF_APITOKEN_ID"
            emit_secret CF_APITOKEN_ZONE "$CF_APITOKEN_ZONE_ID"
            # Aliases for different tools
            echo 'export CF_API_KEY="$CF_APIKEY"'
            echo 'export CF_DNS_API_TOKEN="$CF_APITOKEN"'
            echo 'export CF_ZONE_API_TOKEN="$CF_APITOKEN_ZONE"'
            ;;
        paperless)
            emit_secret PAPERLESS_SECRET_KEY "$PAPERLESS_SECRET_KEY_ID"
            emit_secret POSTGRES_PASSWORD "$POSTGRES_PASSWORD_ID"
            ;;
        pihole)
            emit_secret PIHOLE_PASSWORD "$PIHOLE_PASSWORD_ID"
            ;;
        mariadb)
            emit_secret MYSQL_ROOT_PASSWORD "$MYSQL_ROOT_PASSWORD_ID"
            ;;
        aviationstack)
            emit_secret AVIATIONSTACK_API_KEY "$AVIATIONSTACK_API_KEY_ID"
            ;;
        lego)
            emit_secret GHCR_TOKEN "$GHCR_TOKEN_ID"
            emit_secret GITHUB_TOKEN "$GITHUB_TOKEN_ID"
            ;;
        docker)
            emit_profile cloudflare
            emit_profile paperless
            emit_profile pihole
            emit_profile mariadb
            ;;
        all)
            emit_profile docker
            emit_profile aviationstack
            emit_profile lego
            ;;
        *)
            log "Usage: eval \"\$(load-secrets <profile>)\""
            log "   or: secrets <profile>"
            log ""
            log "Profiles: cloudflare paperless pihole mariadb aviationstack lego docker all"
            exit 1
            ;;
    esac
}

# Check dependencies
if ! command -v bws &>/dev/null; then
    log "Error: bws not installed. Run: brew install bitwarden/bws/bws"
    exit 1
fi

# Get BWS token if needed
if [[ -z "${BWS_ACCESS_TOKEN:-}" ]]; then
    if command -v bw &>/dev/null && bw status 2>/dev/null | grep -q '"status":"unlocked"'; then
        log "Fetching BWS_ACCESS_TOKEN from Bitwarden vault..."
        BWS_ACCESS_TOKEN="$(bw get password 'BWS Access Token' 2>/dev/null)"
        if [[ -n "$BWS_ACCESS_TOKEN" ]]; then
            echo "export BWS_ACCESS_TOKEN='${BWS_ACCESS_TOKEN}'"
        fi
    fi
fi

if [[ -z "${BWS_ACCESS_TOKEN:-}" ]]; then
    log "Error: BWS_ACCESS_TOKEN not set"
    log "  1. Unlock vault: export BW_SESSION=\$(bw unlock --raw)"
    log "  2. Run again, or: export BWS_ACCESS_TOKEN=\$(bw get password 'BWS Access Token')"
    exit 1
fi

emit_profile "${1:-}"
