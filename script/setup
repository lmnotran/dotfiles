#!/bin/bash
#
# setup - One-command setup for a new machine using chezmoi
#
# Usage: ./script/setup [--dry-run]
#
# This script:
#   1. Installs chezmoi
#   2. Applies dotfiles via chezmoi (which runs install-deps automatically)
#
# For a fresh machine without this repo cloned, use:
#   sh -c "$(curl -fsLS get.chezmoi.io)" -- init --apply lmnotran/dotfiles
#
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_DIR="$(dirname "$SCRIPT_DIR")"

DRY_RUN=false
[[ "${1:-}" == "--dry-run" ]] && DRY_RUN=true

# ─────────────────────────────────────────────────────────────────────────────
# Colors
# ─────────────────────────────────────────────────────────────────────────────

if [[ -t 1 ]]; then
    GREEN='\033[0;32m'
    YELLOW='\033[0;33m'
    BLUE='\033[0;34m'
    MAGENTA='\033[0;35m'
    CYAN='\033[0;36m'
    BOLD='\033[1m'
    RESET='\033[0m'
else
    GREEN='' YELLOW='' BLUE='' MAGENTA='' CYAN='' BOLD='' RESET=''
fi

log()      { echo -e "${CYAN}[setup]${RESET} $*"; }
log_step() { echo -e "${BOLD}${BLUE}==>${RESET} ${BOLD}$*${RESET}"; }
log_ok()   { echo -e "${GREEN}✓${RESET} $*"; }
log_warn() { echo -e "${YELLOW}⚠${RESET} $*"; }

main() {
    cd "$REPO_DIR"

    echo ""
    echo -e "${BOLD}${MAGENTA}  ┌─────────────────────────────────────┐${RESET}"
    echo -e "${BOLD}${MAGENTA}  │       ${CYAN}Dotfiles Setup${MAGENTA}                │${RESET}"
    echo -e "${BOLD}${MAGENTA}  └─────────────────────────────────────┘${RESET}"
    echo ""

    log_step "Step 1/2: Installing chezmoi"
    if command -v chezmoi &>/dev/null; then
        log_ok "chezmoi already installed"
    else
        if $DRY_RUN; then
            log "(dry-run) Would install chezmoi to ~/.local/bin"
        else
            # Remove broken symlink if it exists (leftover from stow)
            [[ -L ~/.local/bin ]] && rm ~/.local/bin
            mkdir -p ~/.local/bin
            sh -c "$(curl -fsLS get.chezmoi.io)" -- -b ~/.local/bin
            export PATH="$HOME/.local/bin:$PATH"
        fi
        log_ok "chezmoi installed"
    fi
    echo ""

    log_step "Step 2/2: Applying dotfiles"
    if $DRY_RUN; then
        log "(dry-run) Would run: chezmoi init --source $REPO_DIR/chezmoi --apply"
        chezmoi diff --source "$REPO_DIR/chezmoi" 2>/dev/null || true
    else
        chezmoi init --source "$REPO_DIR/chezmoi" --apply
    fi
    log_ok "Dotfiles applied"
    echo ""

    echo -e "${BOLD}${GREEN}✓ Setup complete!${RESET}"
    echo ""
    echo -e "${BOLD}Next steps:${RESET}"
    echo -e "  ${CYAN}1.${RESET} Restart your terminal (or run: ${YELLOW}exec zsh${RESET})"
    echo -e "  ${CYAN}2.${RESET} Antidote will auto-install zsh plugins on first launch"
    echo ""
    echo -e "${BOLD}Useful commands:${RESET}"
    echo -e "  ${YELLOW}chezmoi diff${RESET}     # See pending changes"
    echo -e "  ${YELLOW}chezmoi apply${RESET}    # Apply changes"
    echo -e "  ${YELLOW}chezmoi edit${RESET}     # Edit managed files"
    echo -e "  ${YELLOW}chezmoi cd${RESET}       # Jump to source directory"
    echo ""
}

main "$@"
