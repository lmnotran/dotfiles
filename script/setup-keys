#!/bin/bash
#
# Downloads SSH and GPG keys from Bitwarden and installs them locally.
# On work machines, sets up both personal and work keys plus an SSH config
# entry for github-personal.
#
# Requires: Bitwarden CLI (bw) - https://bitwarden.com/help/cli/
#
# Usage: ./script/setup-keys
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_DIR="$(dirname "$SCRIPT_DIR")"

# =============================================================================
# Configuration - Bitwarden item names and attachment filenames
# =============================================================================

# Personal keys (always available)
SSH_PERSONAL_ITEM="SSH Key - Personal"
GPG_PERSONAL_ITEM="GPG Key - Personal"
SSH_PERSONAL_PRIVATE="id_ed25519"
SSH_PERSONAL_PUBLIC="id_ed25519.pub"

# Work keys (only used on work machines)
SSH_WORK_ITEM="SSH Key - Work"
GPG_WORK_ITEM="GPG Key - Work"
SSH_WORK_PRIVATE="id_ed25519_work"
SSH_WORK_PUBLIC="id_ed25519_work.pub"

# GPG attachment filename (same name in both Bitwarden items)
GPG_ATTACHMENT="private.gpg"

# =============================================================================
# Helper functions
# =============================================================================
info() {
    echo -e "\033[1;34m==>\033[0m $1"
}

success() {
    echo -e "\033[1;32m==>\033[0m $1"
}

error() {
    echo -e "\033[1;31mError:\033[0m $1" >&2
}

check_bw_installed() {
    if ! command -v bw &> /dev/null; then
        error "Bitwarden CLI (bw) is not installed."
        echo "Install it from: https://bitwarden.com/help/cli/"
        echo "  - macOS: brew install bitwarden-cli"
        echo "  - Linux: snap install bw"
        exit 1
    fi
}

ensure_logged_in() {
    local status
    status=$(bw status | grep -o '"status":"[^"]*"' | cut -d'"' -f4)

    case "$status" in
        "unauthenticated")
            info "Please log in to Bitwarden..."
            bw login
            ;;
        "locked")
            info "Unlocking Bitwarden vault..."
            ;;
        "unlocked")
            info "Bitwarden vault is already unlocked"
            return 0
            ;;
    esac

    if [ -z "${BW_SESSION:-}" ]; then
        BW_SESSION=$(bw unlock --raw)
        export BW_SESSION
    fi
}

get_item_id() {
    local item_name="$1"
    local item_id

    item_id=$(bw get item "$item_name" 2>/dev/null | jq -r '.id') || {
        error "Could not find Bitwarden item: $item_name"
        return 1
    }

    echo "$item_id"
}

# =============================================================================
# Work machine detection
# Reads work.knownUserHosts from chezmoi/.chezmoidata.toml via chezmoi data,
# matching the same logic used in chezmoi/dot_gitconfig.tmpl and dot_zshrc.tmpl.
# =============================================================================
is_work_machine() {
    local username
    username=$(whoami)

    if [[ "$username" == usmastra* ]]; then
        return 0
    fi

    local user_host="${username}@$(hostname -s)"
    chezmoi data --source "$REPO_DIR" --format json \
        | jq -e --arg uh "$user_host" '.work.knownUserHosts | any(. == $uh)' > /dev/null 2>&1
}

# =============================================================================
# SSH Key Setup
# =============================================================================
setup_ssh_keys() {
    local label="$1"
    local item_name="$2"
    local private_key="$3"
    local public_key="$4"

    info "Setting up $label SSH keys..."

    local item_id
    item_id=$(get_item_id "$item_name") || return 1

    mkdir -p ~/.ssh
    chmod 700 ~/.ssh

    info "Downloading $label SSH private key..."
    bw get attachment "$private_key" --itemid "$item_id" --output ~/.ssh/"$private_key"
    chmod 600 ~/.ssh/"$private_key"

    info "Downloading $label SSH public key..."
    bw get attachment "$public_key" --itemid "$item_id" --output ~/.ssh/"$public_key"
    chmod 644 ~/.ssh/"$public_key"

    success "$label SSH keys installed to ~/.ssh/"
}

# =============================================================================
# GPG Key Setup
# =============================================================================
setup_gpg_keys() {
    local label="$1"
    local item_name="$2"

    info "Setting up $label GPG keys..."

    local item_id
    item_id=$(get_item_id "$item_name") || return 1

    local temp_gpg
    temp_gpg=$(mktemp)
    trap 'rm -f "$temp_gpg"' EXIT

    info "Downloading $label GPG private key..."
    bw get attachment "$GPG_ATTACHMENT" --itemid "$item_id" --output "$temp_gpg"

    info "Importing $label GPG key..."
    gpg --import "$temp_gpg"

    rm -f "$temp_gpg"

    success "$label GPG key imported successfully"

    echo ""
    info "Imported GPG keys:"
    gpg --list-secret-keys --keyid-format LONG
}

# =============================================================================
# SSH Config (work machines only)
# =============================================================================
setup_ssh_config_work() {
    local config_file="$HOME/.ssh/config"
    local marker="Host github-personal"

    if [[ -f "$config_file" ]] && grep -q "^$marker" "$config_file"; then
        info "SSH config entry for github-personal already exists, skipping"
        return 0
    fi

    info "Adding github-personal SSH config entry..."

    mkdir -p ~/.ssh
    chmod 700 ~/.ssh

    if [[ -s "$config_file" ]]; then
        echo "" >> "$config_file"
    fi

    cat >> "$config_file" <<EOF
Host github-personal
    HostName github.com
    IdentityFile ~/.ssh/$SSH_PERSONAL_PRIVATE
    IdentitiesOnly yes
EOF

    chmod 600 "$config_file"
    success "SSH config entry added for github-personal"
}

# =============================================================================
# Orchestrators
# =============================================================================
do_ssh() {
    setup_ssh_keys "personal" "$SSH_PERSONAL_ITEM" "$SSH_PERSONAL_PRIVATE" "$SSH_PERSONAL_PUBLIC"
    if is_work_machine; then
        echo ""
        setup_ssh_keys "work" "$SSH_WORK_ITEM" "$SSH_WORK_PRIVATE" "$SSH_WORK_PUBLIC"
        echo ""
        setup_ssh_config_work
    fi
}

do_gpg() {
    setup_gpg_keys "personal" "$GPG_PERSONAL_ITEM"
    if is_work_machine; then
        echo ""
        setup_gpg_keys "work" "$GPG_WORK_ITEM"
    fi
}

# =============================================================================
# Main
# =============================================================================
main() {
    echo "========================================"
    echo "  Bitwarden Key Setup Script"
    echo "========================================"
    echo ""

    check_bw_installed
    ensure_logged_in

    info "Syncing Bitwarden vault..."
    bw sync

    echo ""

    if is_work_machine; then
        info "Work machine detected — will set up personal AND work keys"
    else
        info "Personal machine detected — will set up personal keys only"
    fi

    echo ""

    # Interactive menu
    echo "What would you like to set up?"
    echo "  1) SSH keys only"
    echo "  2) GPG keys only"
    echo "  3) Both SSH and GPG keys"
    echo "  q) Quit"
    echo ""
    read -rp "Choice [1-3, q]: " choice

    case "$choice" in
        1)
            do_ssh
            ;;
        2)
            do_gpg
            ;;
        3)
            do_ssh
            echo ""
            do_gpg
            ;;
        q|Q)
            echo "Exiting."
            exit 0
            ;;
        *)
            error "Invalid choice"
            exit 1
            ;;
    esac

    echo ""
    success "Key setup complete!"
}

main "$@"
